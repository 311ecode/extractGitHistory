# Git Transplant Path Sync-In üîÑ

Synchronizes changes from an external polyrepo back into the original monorepo, completing the round-trip workflow for monorepo component management.

## Parameters

### Required Parameters
1. **`<metadata.json>`** - Path to the metadata JSON file generated by `extract_git_path`
   - **Type**: String (file path)
   - **Description**: Contains extraction details and commit mappings
   - **Example**: `./extract-git-path-meta.json`

2. **`<polyrepo_url>`** - URL of the external polyrepository
   - **Type**: String (Git remote URL)
   - **Description**: The remote repository containing changes to sync back
   - **Example**: `https://github.com/username/extracted-component.git`

### Optional Environment Variables
- **`DEBUG`** - Enable debug output for troubleshooting
  - **Type**: Boolean (any non-empty value enables)
  - **Default**: Not set
  - **Example**: `DEBUG=1 git_transplant_path_sync_in meta.json https://github.com/user/repo.git`

## Usage Examples

### Basic Synchronization
```bash
# Sync changes from external polyrepo back into monorepo
git_transplant_path_sync_in ./extract-git-path-meta.json https://github.com/team/component.git
```

### With Debug Output
```bash
# Enable debug mode to see detailed processing
DEBUG=1 git_transplant_path_sync_in meta.json git@github.com:user/repo.git
```

### Complete Workflow Example
```bash
# 1. Extract a component from monorepo
extract_git_path ./packages/auth-service

# 2. Work on the extracted polyrepo externally
#    (make changes, push to GitHub, etc.)

# 3. Sync changes back into monorepo
git_transplant_path_sync_in ./extract-git-path-meta.json https://github.com/team/auth-service.git
```

## Process Flow

The synchronization follows these steps:

1. **State Capture**: Reads metadata and determines current branch
2. **Polyrepo Fetch**: Fetches latest changes from external repository
3. **Path Transformation**: Re-prefixes polyrepo files to match original monorepo structure
4. **Adoption**: Applies transformed changes to current monorepo branch
5. **Metadata Update**: Records synchronization details in metadata file
6. **Cleanup**: Removes temporary remotes and branches

## Output

### Console Output
- Success: No output (exit code 0)
- Error: Error message to stderr (exit code 1)

### Metadata Updates
The metadata JSON file is updated with a new `git_transplant_path_sync_in` section:
```json
{
  "original_path": "/path/to/extracted/item",
  "original_repo_root": "/path/to/original/repository",
  "relative_path": "packages/auth-service",
  "extracted_repo_path": "/tmp/extract-git-path/.../repo",
  "extraction_timestamp": "2024-01-01T12:00:00Z",
  "commit_mappings": { ... },
  "sync_status": { ... },
  "git_transplant_path_sync_in": {
    "last_run_timestamp": "2024-01-02T15:30:00Z",
    "remote_url": "https://github.com/team/auth-service.git",
    "last_synced_poly_hash": "abc123...",
    "last_synced_mono_hash": "def456..."
  }
}
```

### Repository Changes
- Current branch is updated with synchronized changes
- Commit history is preserved with original timestamps
- Files are placed in their original location within the monorepo

## Dependencies

### Required Tools
1. **Git** - Version control system
   - Verify with: `git --version`

2. **git-filter-repo** - Git history filtering tool
   - Install via pip: `pip install git-filter-repo`
   - Verify with: `git-filter-repo --version`

3. **jq** - JSON processor
   - Install via package manager: `apt-get install jq` or `brew install jq`
   - Verify with: `jq --version`

### Required Files
- Valid metadata JSON file from `extract_git_path`
- Access to the external polyrepository (read permissions)

## Error Handling

The script exits with error codes and messages for:

1. **Missing arguments**: `Usage: git_transplant_path_sync_in <metadata.json> <polyrepo_url>`
2. **Invalid metadata file**: `ERROR: Could not read metadata file`
3. **Unresolvable polyrepo HEAD**: `‚ùå ERROR: Could not resolve Polyrepo HEAD`
4. **Failed branch creation**: `‚ùå ERROR: Failed to create scratch branch`
5. **Network issues**: Git fetch failures for the remote repository

## Safety Features

### Non-Destructive Operations
- Works on temporary branches (`scratch_sync_*`)
- Uses temporary remotes (`sync_remote_*`)
- Original branches are preserved
- Changes can be reviewed before merging

### Automatic Cleanup
- Temporary branches are deleted after use
- Temporary remotes are removed
- No leftover configuration changes

## Technical Details

### Path Transformation Logic
The script uses `git filter-repo --to-subdirectory-filter` to:
1. Take polyrepo files (at repository root)
2. Re-prefix them with the original relative path
3. Preserve all commit metadata (author, date, message)

### Branch Resolution
The script automatically detects the polyrepo's main branch:
1. Tries `main` branch first
2. Falls back to `master` branch
3. Fails if neither exists

### Hash Verification
- Uses `git rev-parse --verify` for clean hash resolution
- Records both polyrepo and monorepo hashes in metadata
- Enables verification of synchronization accuracy

## Integration with Workflow

### Part of Complete Round-Trip
```
Monorepo ‚Üí extract_git_path ‚Üí Polyrepo
    ‚Üë                              ‚Üì
    ‚îî‚îÄ‚îÄ git_transplant_path_sync_in ‚Üê
```

### Testing
Use the included test suite to verify functionality:
```bash
# Run the synchronization test
testGitTransplantWorkflow
```

## Troubleshooting

### Common Issues

1. **"Could not resolve Polyrepo HEAD"**
   ```bash
   # Verify the repository exists and is accessible
   git ls-remote <polyrepo_url>
   
   # Check branch names in the polyrepo
   git ls-remote --heads <polyrepo_url>
   ```

2. **Permission denied for remote**
   ```bash
   # Ensure you have read access to the polyrepo
   # For private repos, ensure SSH keys or tokens are configured
   ```

3. **Metadata file not found or invalid**
   ```bash
   # Verify the metadata file exists
   ls -la ./extract-git-path-meta.json
   
   # Check JSON validity
   jq . ./extract-git-path-meta.json
   ```

4. **git-filter-repo not installed**
   ```bash
   # Install the required tool
   pip install git-filter-repo
   ```

### Debug Mode
Enable detailed output to diagnose issues:
```bash
DEBUG=1 git_transplant_path_sync_in meta.json https://github.com/user/repo.git
```

Debug output includes:
- Temporary branch and remote names
- Path transformation details
- Hash resolutions
- Processing steps

## Notes

- The script must be run from within the target monorepo
- Current branch will be updated in-place (consider creating a backup branch first)
- Metadata file is updated but original extraction data is preserved
- Synchronization is one-way (polyrepo ‚Üí monorepo)
- Large repositories may take several minutes to process
- Network speed affects fetch performance

## Related Commands

- `extract_git_path` - Extract component from monorepo
- `git_path_transplant` - Initial transplant of extracted history
- `testGitTransplantWorkflow` - Test the complete round-trip workflow
