# Git Path Transplanter ü©∫

Replays isolated directory history back into a monorepo at a new destination path while preserving original metadata.

## Parameters

### Required Parameters
1. **`<metadata.json>`** - Path to the metadata file generated by `extract_git_path`
   - **Type**: File path (JSON)
   - **Format**: Must be a valid `extract-git-path-meta.json` file
   - **Example**: `./extract-git-path-meta.json` or `/tmp/extract_12345/extract-git-path-meta.json`

2. **`<destination_path>`** - Target path in the monorepo where the extracted content should be placed
   - **Type**: String (directory path)
   - **Note**: Should be a relative path from the monorepo root
   - **Example**: `packages/new-feature` or `src/modules/auth`

### Optional Environment Variables
- `DEBUG` - Enable debug output for troubleshooting
  - **Type**: Boolean (any non-empty value enables)
  - **Default**: Not set
  - **Example**: `DEBUG=1 git_path_transplant meta.json packages/new-feature`

## Usage Examples

### Basic Usage
```bash
# Navigate to your monorepo
cd /path/to/your/monorepo

# Transplant extracted history into a new location
git_path_transplant ./extract-git-path-meta.json packages/new-feature
```

### With Debug Output
```bash
# Enable debug mode to see detailed processing
DEBUG=1 git_path_transplant /tmp/extract_12345/extract-git-path-meta.json src/components
```

### Complete Workflow Example
```bash
# 1. Extract a directory from source repository
extract_git_path /old/repo/src/utils

# 2. Navigate to target monorepo
cd /new/monorepo

# 3. Transplant the extracted history
git_path_transplant /tmp/extract_12345/extract-git-path-meta.json packages/shared-utils
```

## Output

The script performs the following actions:

1. **Creates a temporary branch** named `history/<destination_path>` containing the transplanted history
2. **Outputs instructions** for integrating the history into your current branch

### Example Output
```
‚úÖ SUCCESS: History grafted onto branch history/packages/new-feature
üí° To view the history: git log history/packages/new-feature
üí° To integrate into your current branch WITHOUT changing hashes, use: git merge history/packages/new-feature --allow-unrelated-histories
```

## Process Flow

### Step 1: Validation
- Verifies the metadata file exists and is accessible
- Extracts the path to the extracted repository from the JSON metadata

### Step 2: Path Re-prefixing
- Uses `git-filter-repo` to move files from the extracted repository's root into the specified destination directory
- Example: Files at `/` become `/packages/new-feature/`

### Step 3: History Grafting
- Adds the extracted repository as a remote (`transplant_source`)
- Fetches the re-prefixed history into the monorepo
- Creates a branch pointing to the transplanted history (orphaned from current main)

### Step 4: Cleanup
- Removes the temporary remote
- Outputs integration instructions

## Dependencies

The script requires the following tools:

1. **Git** - Version control system
   - Verify with: `git --version`

2. **git-filter-repo** - Advanced Git history filtering tool
   - Install via pip: `pip install git-filter-repo`
   - Verify with: `git-filter-repo --version`

3. **jq** - Command-line JSON processor
   - Install via package manager: `apt-get install jq` or `brew install jq`
   - Verify with: `jq --version`

## Error Handling

The script will exit with an error and appropriate message if:

1. **Missing metadata file**: `‚ùå ERROR: Metadata file not found: <path>`
2. **Invalid JSON format**: `jq` parsing errors
3. **Missing extracted repository**: Cannot access the path specified in `extracted_repo_path`
4. **git-filter-repo failure**: Errors during path re-prefixing
5. **Git operations failure**: Issues with fetching or branch creation

## Integration Options

After running `git_path_transplant`, you have several options:

### Option 1: Merge with Unrelated Histories
```bash
# Merge the transplanted history into your current branch
git merge history/packages/new-feature --allow-unrelated-histories
```

### Option 2: Review History First
```bash
# Examine the transplanted commits
git log history/packages/new-feature --oneline

# View file changes
git diff main..history/packages/new-feature --stat
```

### Option 3: Cherry-pick Specific Commits
```bash
# Select specific commits to integrate
git cherry-pick <commit-hash1> <commit-hash2>
```

## Technical Details

### Branch Strategy
- Creates an **orphan branch** with no connection to your current `main`/`master`
- Branch naming pattern: `history/<destination_path>`
- This preserves the original commit hashes from the extracted repository

### Path Transformation
The script performs a `--to-subdirectory-filter` operation:
```
Original extracted structure:
/
‚îú‚îÄ‚îÄ file1.js
‚îî‚îÄ‚îÄ file2.js

After transformation (destination_path = "packages/new-feature"):
/
‚îî‚îÄ‚îÄ packages/
    ‚îî‚îÄ‚îÄ new-feature/
        ‚îú‚îÄ‚îÄ file1.js
        ‚îî‚îÄ‚îÄ file2.js
```

### Metadata Usage
The script reads the following from the metadata JSON:
- `extracted_repo_path`: Location of the extracted Git repository
- `original_path`: Original path in the source repository (for reference)
- `relative_path`: Path within the original repository (for reference)

## Safety Features

1. **No modification to current branch**: Works on temporary branches only
2. **Preserves original hashes**: Uses `git fetch` to bring in objects without modification
3. **Clean remote management**: Adds and removes temporary remotes automatically
4. **Explicit integration**: Requires manual merge with `--allow-unrelated-histories`

## Troubleshooting

### Common Issues

1. **"jq: command not found"**
   ```bash
   # Install jq
   sudo apt-get install jq      # Ubuntu/Debian
   brew install jq              # macOS
   ```

2. **"git-filter-repo is not installed"**
   ```bash
   pip install git-filter-repo
   ```

3. **Merge conflicts during integration**
   ```bash
   # Resolve conflicts manually
   git status                   # See conflicted files
   git mergetool               # Use merge tool
   git commit                  # Complete the merge
   ```

4. **Destination path already exists**
   - The script will overwrite existing files in the destination path
   - Consider using a different destination path or backing up existing files

### Debug Mode
Enable debug output to see detailed processing:
```bash
DEBUG=1 git_path_transplant meta.json packages/new-feature
```

This will show:
- Metadata extraction details
- Path transformation steps
- Git operation progress
- Branch creation information

## Related Tools

- **`extract_git_path`**: Creates the metadata file used by this tool
- **`git_transplant_path_sync_in`**: For syncing changes from external repositories back into the monorepo
- **`testGitTransplantWorkflow`**: Test suite for the complete transplant workflow

## Notes

- The original extracted repository is not modified
- The monorepo's current branch is not changed (only a new branch is created)
- Commit timestamps and authors are preserved from the original history
- Large histories may take several minutes to process
- Temporary remotes are cleaned up automatically
- The `history/` branch prefix helps identify transplanted histories
